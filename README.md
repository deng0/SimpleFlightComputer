# SimpleFlightComputer

This repository contains code to test different concepts of how a spaceship in Star Citizen should apply thrust to achieve a desired velocity vector from a current velocity vector (coupled mode). A velocity vector describes the direction and speed the ship travels in.

In coupled mode the pilot specifies his desired velocity vector (strafe input depending on current ship orientation multiplied by speed limit (maximum ship speed when speed limit is disabled)).
The IFCS in coupled mode determines how to use your thrusters to achieve the new velocity vector in regards to your current velocity vector.
In other words the IFCS determines thrust power and burn time that each thruster has to perform to achieve the new velocity vector.

This repository contains three different concepts.
All of these use the same underlying physics and the same thrust restrictions of the spaceships.

## "max thrust" coupled mode
This mode always uses the maximum thrust power of each thruster resulting in different burn times for each thruster.
This matches the IFCS of Star Citizen 3.9. 

## "stable" coupled mode
In 3.10 the IFCS now determines the minimum burn time needed for each relevant thruster and then uses that burn time for all thrusters, meaning that only one thruster uses maximum thrust and the others use only so much thrust that they get their job done right at the same time as the one using maximum thrust. This results in a constant acceleration until the new velocity vector is achieved whereas before the acceleration would change each time a thruster has reached its needed burn time.

## "anti-drift stable" coupled mode
This is a new concept that tries to combine the benefits of the "max thrust" and "stable" modes above.
Without increasing the total time to achieve the desired velocity vector this mode tries to eliminate any drift as fast as possible but still do stable acceleration after that.
Drift is defined as any motion that is not in the direction of the desired velocity vector. It works for every possible direction of desired velocity vectors, not just when the pilot wants to fly straight forward.

## Comparison
The following pictures have been created from data generated by the algorithms found in this repository.
Although these are just 2D representations the algorithm uses 3D space.
They show a view from above with the spaceship aligned like this:

![orientation](Images/spaceship.png)

They illustrate the benefits and weaknesses of the different modes.

The left side shows the velocity vectors. The dark blue arrow is the current velocity vector and the light blue arrow is the desired velocity vector.
The blue circle show the speed limit that is currently set by pilot (maximum ship speed when speed limit is disabled).
The red line shows the path of how the velocity vector is transformed when the "max thrust" mode is used.
The green line is the "stable" mode and the dashed black line is the "anti-drift stable" mode.
While the IFCS is performing the maneuver the direction and speed of the ship can vary greatly between the three modes.

This can obviously have large impacts on the flight path which is shown on the right. 
The blue point shows the location of the ship when the maneuver is started and the lines show the different flight paths.
The end of the lines represent the position of the ship when the desired velocity vector is finally achieved. 
As mentioned above all three modes need exactly the same amount time to do so.
In theses examples the ship's thrust values and mass are set to those of an Avenger.
(All these parameters including any possible combination of current and desired velocity vector can be fully customized.)

![withinspeedlimit](Images/withinspeedlimit.png)

This case is as follows. The ship is traveling sideways with having reached its currently set speed limit. The pilot now determines that he wants to go forward instead.
Because of the fact that the aft thrusters of the ship are stronger in the "max thrust" mode halfway through the maneuver they will have finished their work and only the side thrusters will still be firing resulting in a change of acceleration direction, but also that the ship will carry a lot more forward speed through most of the maneuver. 
This will also have the effect that for a part of the maneuver the ship will exceed the speed limit set by the pilot (which can have negative impacts on gimbal performance).
The two "stable" modes will throttle the aft thrusters to achieve stable acceleration throughout the maneuver. 
Typically the aft thrusters will overheat faster than side thrusters and because the aft thrusters are not going full power, this should make it possible to use the afterburner for a longer duration in the beginning of the maneuver than would be possible with the "max thrust" mode, which will slightly improve the forward speed but more importantly will make the "stable" modes outperform the "max thrust" mode when it comes to eliminating drift in cases like these.

![antidrift](Images/antidrift.png)

This case is similar to the previous one but this time the pilot has no speed limit set or is currently traveling way below the speed limit.
This shows the main problem of the normal "stable" coupled mode which is used in Star Citizen 3.10, namely that it is very bad at countering the drift.
The improved "anti-drift stable" coupled mode is capable of determining that in cases like this it's more important to counter the drift as fast as possible than to have a purely constant acceleration.

![stable_antidrift.png](Images/stable_antidrift.png)

This case shows that the "anti-drift stable" does not just work in special cases like the one above. Additionally once it has successfully countered the drift it will perfectly align with the desired acceleration direction resulting in a smoother flight path.

![stable.png](Images/stable.png)

In this case the ship is currently in standstill and the pilot sets a new desired velocity vector. In "max thrust" mode the ship will accelerate in a direction that does not match the direction of the desired velocity vector resulting in flight path that is not straight. In both "stable" modes the flight path perfectly matches the desired direction.
This will be perfectly suited when trying to perform precise docking/landing maneuvers.

![fullstop.png](Images/fullstop.png)

In this case the pilot decides that he wants to come to a full stop. Although the "max thrust" mode will ensure that the ship travels the shortest distance before coming to a full stop the flight path will be slightly unpredictable.

![spacebreak.png](Images/spacebreak.png)

Same situation as the example above but now the pilot engages spacebrake. In this case the "anti-drift stable" prioritizes max thrust over stability.

## Conclusion
In all cases I can think of the "anti-drift stable" mode described here would be better suited than the simple "stable" mode currently implemented in Star Citizen 3.10.
Only in some very specific situations the basic "max thrust" mode might provide better results, but that might be mitigated by the fact that in these same situations "anti-drift stable" mode might allow for longer afterburner durations. So I would suggest that CIG updates their coupled mode to something similar to this "anti-drift stable" mode. Then they could still add a toggle to switch between "anti-drift stable" and "max thrust" coupled mode, but I don't think that would be necessary.

## Source Code
The FlightComputer class is the most interesting class which takes a SpaceShip instance (containing information about the ship's capabilities, state, pilot's intentions) and computes the thrust values to apply. The different modes are represented by different methods: DetermineMaxThrust, DetermineStableThrust and DetermineStableAntiDriftThrust.
To generate the data how the velocity vector changes and results in a flight path, you can use the PerformManeuver method located in the Tests class.

## Short mathematical explanation of the "anti-drift stable" coupled mode
The basic idea behind this mode is to determine whether or not using max thrust instead of stable thrust will bring the velocity vector closer to the direction of the desired velocity vector.
This can be done for each thrust axis independently.
A graphical explanation looks like this:

![formula.png](Images/formula.png)

The **t** axis is the time. **0** is now and **tt** will be the time at which the new velocity vector will be fully achieved along all of the thrust axis.
The **v** axis is the velocity along the corresponding thrust axis.
The slope of each of the three lines represent different acceleration values.
**am** matches the acceleration that will be achieved when full thrust is used.
**aS** matches the acceleration when stable thrust is used.
and **ad** matches the acceleration the thruster can achieve when the ship would already be traveling in the direction of the desired velocity vector.
When the intersection of the **am** and **ad** is between **0** and **tt** then max thrust should be preferred otherwise stable thrust will be used.
For more details and formulas have a look at the DetermineStableAntiDriftThrust method.
